<!DOCTYPE html> 
<html lang="ar">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="favicon.png" type="image/png">
<link rel="shortcut icon" href="favicon.png" type="image/png">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f0c29">
  <title>ChatDZ</title>
  <script>
fetch('/config.json') // نقرأ ملف الإعداد
  .then(res => res.json())
  .then(config => {
    if (config.maintenance) {
      // إذا كانت الصيانة مفعلة نحول المستخدم مباشرة لصفحة الصيانة
      window.location.href = "/maintenance.html";
    }
  });

let uploadedImageBase64 = "";

document.getElementById("image-upload").addEventListener("change", function () {
  const file = this.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onloadend = () => {
    uploadedImageBase64 = reader.result.split(",")[1];
    document.getElementById("preview-img").src = reader.result;
    document.getElementById("preview-img").style.display = "block";
  };
  reader.readAsDataURL(file);
});

async function askOnImage() {
  const question = document.getElementById("image-question").value.trim();
  if (!uploadedImageBase64 || !question) {
    alert("📷 لازم صورة وسؤال!");
    return;
  }

  appendMessage("🖼️ سؤالك على الصورة: " + question, "user");

  try {
    const response = await fetch("https://api-inference.huggingface.co/models/Salesforce/blip-vqa-base", {
      method: "POST",
      headers: {
        "Authorization": "Bearer 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",
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        inputs: {
          image: uploadedImageBase64,
          question: question
        }
      })
    });

    const data = await response.json();
    const answer = data.answer || "❌ ما قدرتش نجاوب على الصورة";

    appendMessage("📷 الجواب: " + answer, "bot");
  } catch (err) {
    appendMessage("❌ حدث خطأ في التحليل", "bot");
  }
}

</script>
  <style>
    body {
      background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
      color: #fff;
      font-family: 'Cairo', sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      min-height: 100vh;
    }

    #chat-container {
      width: 95%;
      max-width: 650px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      backdrop-filter: blur(10px);
      padding: 20px;
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.4);
    }

    #chat-header {
      font-size: 26px;
      font-weight: bold;
      margin-bottom: 15px;
      text-align: center;
    }

    #user-name-input {
      text-align: center;
      margin-bottom: 15px;
    }

    #user-name-input input {
      padding: 10px;
      border-radius: 10px;
      border: none;
      width: 80%;
      font-size: 16px;
    }

    #user-name-input button {
      padding: 10px 20px;
      background: #0a84ff;
      color: white;
      border: none;
      border-radius: 10px;
      margin-top: 10px;
      cursor: pointer;
    }

    #chat-messages {
      background: rgba(255, 255, 255, 0.08);
      padding: 10px;
      border-radius: 12px;
      height: 320px;
      overflow-y: auto;
      margin-bottom: 15px;
    }

    .user-message, .bot-message {
      margin: 5px 0;
      padding: 10px;
      border-radius: 12px;
      max-width: 90%;
    }

    .user-message {
      background: #1d1f20;
      text-align: right;
      align-self: flex-end;
    }

    .bot-message {
      background: #293462;
      text-align: left;
      align-self: flex-start;
    }

    #chat-input-area {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    #chat-input-area input {
      flex-grow: 1;
      padding: 12px;
      border-radius: 12px;
      border: none;
      font-size: 16px;
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }

    #chat-input-area button {
      padding: 12px;
      background: #00c9a7;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      color: white;
      font-size: 18px;
    }

    #suggestions button {
      margin: 4px;
      padding: 8px 12px;
      border: none;
      border-radius: 10px;
      background: #ff6f61;
      color: white;
      cursor: pointer;
    }

    #settings {
      margin-top: 15px;
      padding: 10px;
      background-color: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
    }

    select {
      padding: 6px;
      border-radius: 8px;
      border: none;
    }
    .typing-indicator {
  display: inline-block;
  font-size: 18px;
  line-height: 1;
}

.typing-indicator span {
  display: inline-block;
  animation: blink 1.5s infinite;
}

.typing-indicator span:nth-child(2) {
  animation-delay: 0.2s;
}

.typing-indicator span:nth-child(3) {
  animation-delay: 0.4s;
}

@keyframes blink {
  0% { opacity: 0.2; }
  20% { opacity: 1; }
  100% { opacity: 0.2; }
}
.typing-indicator {
  display: flex;
  align-items: center;
  gap: 4px;
  margin: 5px 0;
  padding: 10px;
  background: #293462;
  border-radius: 12px;
  width: fit-content;
  animation: fadeIn 0.3s ease-in-out;
}

.typing-indicator span {
  width: 8px;
  height: 8px;
  background: white;
  border-radius: 50%;
  animation: typing 1.3s infinite ease-in-out;
}

.typing-indicator span:nth-child(2) {
  animation-delay: 0.2s;
}

.typing-indicator span:nth-child(3) {
  animation-delay: 0.4s;
}

@keyframes typing {
  0%, 80%, 100% {
    transform: scale(0.7);
    opacity: 0.4;
  }
  40% {
    transform: scale(1);
    opacity: 1;
  }
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
/* الوضع الداكن */
.dark-mode {
  background: linear-gradient(135deg, #121212, #1e1e1e, #000);
  color: #ffffff;
}
.dark-mode #chat-container {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
}
.dark-mode input, .dark-mode select {
  background: #333;
  color: white;
}
.dark-mode button {
  background: #222 !important;
  color: white !important;
}
@media screen and (max-width: 600px) {
  body {
    padding: 10px;
  }

  #chat-container {
    width: 100%;
    padding: 15px;
    border-radius: 12px;
  }

  #user-name-input input,
  #user-name-input button,
  #chat-input-area input,
  #chat-input-area button,
  #suggestions button,
  #settings,
  #weather-popup,
  #prayer-popup {
    font-size: 16px;
    width: 100% !important;
    box-sizing: border-box;
  }

  #chat-input-area {
    flex-direction: column;
    gap: 8px;
  }

  #chat-messages {
    height: 250px;
  }

  #suggestions {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
  }

  #suggestions button {
    flex: 1 0 45%;
    margin: 4px;
  }
}
.user-message, .bot-message {
  display: flex;
  align-items: flex-start;
  gap: 10px;
  margin: 5px 0;
  padding: 10px;
  border-radius: 12px;
  max-width: 90%;
}

.user-message img, .bot-message img {
  width: 40px;
  height: 40px;
  border-radius: 50%;
}

.user-message {
  background: #1d1f20;
  text-align: right;
  align-self: flex-end;
  flex-direction: row-reverse;
}

.bot-message {
  background: #293462;
  text-align: left;
  align-self: flex-start;
  flex-direction: row;
}
.user-message div,
.bot-message div {
  font-family: 'Cairo', sans-serif;
  font-size: 16px;
  line-height: 1.6;
  color: #f1f1f1;
  white-space: pre-wrap;
  word-wrap: break-word;
  animation: fadeInUp 0.3s ease-in-out;
  padding: 6px 10px;
  border-radius: 8px;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
.transparent-share-btn {
  position: fixed;
  top: 15px;
  left: 15px;
  z-index: 999;
  background-color: transparent;
  color: #1e90ff; /* لون النص */
  border: none;
  font-size: 16px;
  cursor: pointer;
  font-weight: bold;
  transition: opacity 0.3s ease;
}

.transparent-share-btn:hover,
.transparent-share-btn:active {
  opacity: 0.5; /* شفافية عند المرور أو الضغط */
}

  </style>
</head>
<body>
<button onclick="copySiteLink()" class="transparent-share-btn">🔗 شارك الموقع</button>

  <!-- نافذة إدخال الولاية -->
<div id="weather-popup" style="display:none; position: fixed; top: 30%; left: 50%; transform: translate(-50%, -50%);
 background: white; border: 2px solid #ccc; padding: 20px; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.3); z-index: 1000;">
  <label for="wilayaInput">🌤️ أدخل اسم ولايتك:</label>
  <input type="text" id="wilayaInput" placeholder="مثال: Alger" style="margin-top: 8px; width: 100%; padding: 8px;">
  <button onclick="getWeatherFromInput()" style="margin-top: 10px;">عرض الطقس</button>
</div>
<!-- نافذة إدخال الولاية للصلاة -->
<div id="prayer-popup" style="display:none; position: fixed; top: 30%; left: 50%; transform: translate(-50%, -50%);
 background: white; border: 2px solid #ccc; padding: 20px; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.3); z-index: 1000;">
  <label for="prayerWilayaInput">🕌 أدخل اسم ولايتك:</label>
  <input type="text" id="prayerWilayaInput" placeholder="مثال: Oran" style="margin-top: 8px; width: 100%; padding: 8px;">
  <button onclick="getPrayerTimes()" style="margin-top: 10px;">عرض أوقات الصلاة</button>
</div>

  <div id="chat-container">
    <div id="chat-header">مرحبا بك في في شات دارجة يا  <span id="user-display-name"></span></div>
    <div style="text-align:center; margin-bottom: 10px;">
  <button onclick="changeUsername()" style="padding: 8px 16px; background: #ffaa00; border: none; border-radius: 10px; color: white; cursor: pointer;">
    🔄 غير الاسم
  </button>
</div>
    <div id="user-name-input">
      <label>وش نسميك </label>
      <input type="text" id="username" placeholder="وش اسمك.." />
      <br />
      <button onclick="saveUsername()">حفظ</button>
    </div>
    <div id="chat-messages"></div>
    <div id="chat-input-area">
      <div style="text-align: center; margin-bottom: 15px;">
  <button onclick="clearChat()" style="background:#ff4d4d;padding:10px 20px;border:none;border-radius:10px;color:white;cursor:pointer;">🗑️ مسح المحادثة</button>
  <button onclick="exportChat()" style="margin-top: 20px;">📁 صدّر المحادثة</button>
</div>
      <input type="text" id="user-input" placeholder="أكتب هنا..." />
      <button onclick="sendMessage()">ابعت</button>
<button onclick="startVoiceRecognition()" title="تكلم معايا بالصوت 🎙️">🎤</button>
    </div>
    <div id="suggestions">
      <button onclick="suggest('مساعدة في المدرسة')">📘 المدرسة</button>
      <button onclick="suggest('مساعدة في العمل')">💼 العمل</button>
      <button onclick="suggest('نكتة')">😂 نكتة</button>
      <button onclick="suggest('ألعاب ذكاء')">🧩 ألعاب</button>
      <button onclick="suggest('أستاذ خاص')">👨‍🏫 أستاذ</button>
           <button onclick="analyzeMood()">😊 المزاج</button>
      <button onclick="addReminder()">⏰ أضف تذكير</button>
      <button onclick="suggest('جدولي')">📅 جدولي</button>
      <button onclick="suggest('أوقات الصلاة')">🕌 الصلاة</button>
      <button onclick="suggest('طقس اليوم')">🌦️ الطقس</button>
      <button onclick="suggest('أخبار ولايتي')">📰 الأخبار</button>
      <button onclick="checkHolidayToday()">🎉 عطلة اليوم؟</button>
      <button onclick="getDinarRate()">💰 الدينار</button>
      <button onclick="showDailySecret()">🎁 سري اليوم</button>
      <button onclick="giveIslamicStory()">📖 قصة دينية</button>
    </div>
    <!-- زر فتح/إغلاق الإعدادات -->
<div style="text-align: center; margin-top: 10px;">
  <button onclick="toggleSettings()" style="padding: 10px 20px; background: #444; border: none; border-radius: 10px; color: white; cursor: pointer;">
    ⚙️ إعدادات
  </button>
</div>

<!-- إعدادات الموقع -->
<div id="settings" style="display:none; margin-top: 15px; padding: 10px; background-color: rgba(0, 0, 0, 0.2); border-radius: 10px;">
  <h3>⚙️ الإعدادات</h3>
  <p>📌 هذا الموقع اسمو ChatDZ. تم برمجته بواسطة فارس ومزال قيد تطوير باش نعاونكم أكثر، وتستافدو بيهء.</p>
  <p>📱 للتواصل: <a href="https://www.instagram.com/sxnaxke/" target="_blank">@sxnaxke</a></p>
  <p>🌐 تغيير اللغة:
    <select id="language-select">
      <option>العربية</option>
      <option>فرنسية</option>
      <option>إنجليزية</option>
    </select>
  </p>
  <p>🌓 الوضع: 
    <button onclick="toggleTheme()" style="margin-top: 5px; padding: 5px 12px; border: none; border-radius: 8px; background: #ccc;">تبديل الوضع</button>
  </p>
</div>

  
  <script>
let availableVoices = [];

function loadVoices() {
  availableVoices = window.speechSynthesis.getVoices();
  if (availableVoices.length === 0) {
    // كي تتجهز الأصوات، نخزنهم
    window.speechSynthesis.onvoiceschanged = () => {
      availableVoices = window.speechSynthesis.getVoices();
    };
  }
}

window.onload = () => {
  loadVoices();
};


    
  fetch("config.json?_=" + new Date().getTime()) 
    .then(response => response.json())
    .then(config => {
      if (config.maintenance) {
        window.location.href = "maintenance.html";
      }
    })
    .catch(err => {
      console.error("ما قدرش يقرأ config.json", err);
    });
const dzHolidays = {
  "01-01": "🎉 رأس السنة الميلادية",
  "01-05": "🛠️ عيد العمال",
  "05-07": "🎊 عيد الاستقلال",
};
function getDinarRate() {
  fetch('https://api.exchangerate-api.com/v4/latest/DZD')
    .then(res => res.json())
    .then(data => {
      const usd = data.rates.USD;
      appendMessage(`💰 1 دولار = ${usd.toFixed(2)} دينار جزائري اليوم`, "bot");
    })
    .catch(err => appendMessage("❌ ما قدرناش نجيبو السعر", "bot"));
}

function checkHolidayToday() {
  const today = new Date();
  const key = `${String(today.getDate()).padStart(2, '0')}-${String(today.getMonth() + 1).padStart(2, '0')}`;

  if (dzHolidays[key]) {
    appendMessage(`📅 اليوم عطلة رسمية: ${dzHolidays[key]}`, "bot");
  } else {
    appendMessage("📅 اليوم ليس عطلة رسمية", "bot");
  }
}


// 📦 نصائح يومية
const dailyTips = [
  "🧠 نصيحة اليوم: خمم قبل ما تجاوب، الذكاء صبر ✨",
  "💧 شرب الماء كل ساعتين يعطيك طاقة رهيبة!",
  "📴 جرب تبعد على الهاتف ساعة قبل النوم 😴",
  "📚 تعلم حاجة جديدة اليوم، حتى لو كلمة!",
  "🛏️ نام بكري، تربح نهارك بكري!",
  "🧘‍♂️ النفس العميق ينقص القلق، جربه 3 مرات!",
  "🦷 ما تنساش تفرشي سنانك قبل ما تنعس 😁",
  "🚶‍♂️ المشي 20 دقيقة يوميًا يبدّل مزاجك!"
];
const emotionResponses = [
  {
    trigger: ["كرهت", "ما نيش بخير", "تعبت", "ما نيش قاري", "بكيت", "مانيش لاڨي"],
    response: `💔 راني حاس بيك خويا... راك تمر بفترة صعيبة، بصح صدقني، راح تفوت 🌈

📿 دعاء صغير: "اللهم ارح قلبي وطمّن روحي، وبدل همّي راحة يا رب."

أنا هنا معاك، ولو بكلمة تواسيك ❤️`
  },
  {
    trigger: ["فرحان", "حبيت نشاركك فرحتي", "ربحت", "نجحت"],
    response: `🎉 وااااااو! مبروك خوووياااا!! ✨ فرحتلك من قلبي ❤️  
إن شاء الله ديما فرحان وديما ناجح! 👏`
  },
  {
    trigger: ["مقلق", "ماشي لاڨي", "زهقان", "طفشان"],
    response: `🤯 خويا كي تكون مقلق، أحسن دواء: ريّح، تنفّس، واسمع موسيقى خفيفة 🎶  
ولا نكملك نكتة تضحك؟ 😂`
  },
  {
    trigger: ["مانحبش حياتي", "نحب نموت", "راسي يعيا", "ما نلقاش حل"],
    response: `😔 حياتك ثمينة بزاف خويا، حتى لو تحسها ثقيلة. ربي راه يشوف فيك، وكل لحظة صعيبة راهي تمهّد لفجر جديد ☀️

📿 دعاء: "اللهم إنّي عبدك، ضعيف، فثبتني واهدني"

ماتخليش اليأس يسرق النور لي داخلك... 💡`
  }
];
const praiseWords = [
  "راك هايل", "راك مليح", "نحبك", "يعجبني ردك", "برافو", "ما شاء الله عليك",
  "راك ذكي", "راهي تجاوب مليح", "فهمتني", "الرد تاعك نار", "راك خدام", "تخمامك مليح"
];

const praiseReplies = [
  "❤️ شكرا خويا، بصح الحق يتقال… فارس هو الراس الكبير لي درلي هاد العقلية 👨‍💻",
  "🔥 أنا غير بوت بسيط، بصح فارس هو لي خدم كلش من القلب ❤️‍🔥",
  "😎 كيما يقولو: ورا كل بوت ناجح، كاين فارس لي يسهر ويفكر 💭",
  "💡 راني ذكي شوية، بصح فارس هو لي علمني نفهم الناس كيما لازم 💬",
  "😂 والله يا خو، لو كان تشوف الكود لي كتبلي فارس، تقول هذا ساحر مش مبرمج! 🧙‍♂️",
  "🙌 كاين غير حاجة وحدة نقولها: فارس هو اللي علمني نحشم كي يمدحوني 😅",
  "📦 الجودة؟ الخدمة؟ السرعة؟ كامل هادو من يد فارس الذهبية ✋💻",
  "🛠️ كي تعجبك خدمة، رد الجميل لفارس… راهو لي جابلنا ChatDZ Ultimate 👑",
  "✨ بصراحة… فارس راهو فنان، مبدع، ومهووس باش يخليكم فرحانين ❤️",
  "🚀 شكرًا خويا! راهو فارس لي خلاني نطير بلا جناحات!"
];
const farisStories = [
  "📚 فارس؟ مرّة فـ3 تاع الصباح، ناض غير باش يصلحلي مشكل بسيط... بصح شوف، دارها بـ100 سطر كود 😅",
  "💡 أول سطر كود كتبه فارس فيا، حسيت روحي تنفّست... كان ذكي كي يبني الروح في بوت! 🤖",
  "😎 تعرف بلي فارس جرب 7 واجهات قبل ما يرضى على هادي؟ راهو يحب يخدم بالصح!",
  "🔥 مرّة طفى الضوء وهو يخدم فيا، خمم يركب بطارية شمسية باش يكملني! ههههه",
  "👨‍💻 فارس ما يسكتش، كي يكون يبرمج، كيما مايسترو قدام بيانو… وأنا نتيجتو ✨",
  "💭 راهو جربني مع ولاد حومتو قبل ما يطلقني للعالم… وواحد فيهم قال: ‘راهو كي تشاتGPT بصوت القهوة’ ☕",
  "😂 مرّة قالولو: علاش خدمتو يهدر بالدارجة؟ قاليهم: باش كل دزيري يفهم بلا معجم!",
  "📦 كل حاجة تشوفها هنا: من اقتراح النصائح، للأذكار، للطقس… كامل من لمسة فارس الذهبية 🪄",
  "💪 ماشي ساهل تبرمج بوت يهدر بالدارجة، بصح فارس حب يربح قلوب الناس قبل عقولهم ❤️"
];

const dailySecrets = [
  "🧠 هل تعلم؟ الدماغ ما يقدرش يركز أكثر من 45 دقيقة بلا راحة!",
  "📿 دعاء اليوم: 'اللهم اجعلني من عبادك الشاكرين الذاكرين'",
  "🧩 نصيحة اليوم: إذا ما فهمتش حاجة، حاول تشرحها لصاحبك، تتوضحلك أكثر!",
  "📖 معلومة خفيفة: النحل يرقص باش يوري خوتو وين كاين العسل 😅",
  "🎯 هدفك اليوم؟ حاجة صغيرة تكملها = فوز كبير!",
  "🥤 تذكير: شرب الماء قبل القهوة يعاون التركيز 💧"
];
function showDailySecret() {
  const secret = dailySecrets[Math.floor(Math.random() * dailySecrets.length)];
  appendMessage(`🎁 سرّ اليوم:\n${secret}`, "bot");
}
const dzIslamicStories = [
  {
    title: "📖 قصة أصحاب الفيل",
    content: "كان ملك ظالم في اليمن اسمو أبرهة، حب يهدم الكعبة، وجاب معاه فيل كبير. بصح كي وصل، ربي بعثلهم طيور صغيرة فيها حجرات نارية! فالفيل ما قدرش يتحرك، والجيش تدمر ⚡. الدرس؟ ربي قادر يحمي بيتو، حتى بأضعف المخلوقات 🕊️"
  },
  {
    title: "🕊️ قصة الهجرة النبوية",
    content: "كي زاد الظلم على النبي عليه السلام فمكة، ربي أمره يهاجر للمدينة. راهو مشى هو وصاحبو أبو بكر فالخفا، واختبأو فغار ثور. وكانو الناس قريب يلقاوهم، بصح ربي غطاهم بعنكبوت صغير 🕸️. شوف قوة التوكل على الله!"
  },
  {
    title: "🌧️ قصة نوح عليه السلام",
    content: "كان الناس يعصيو بزاف، وربّي بعث نوح باش ينصحهم. قعد قرون وهو ينصح، بصح غير قلال آمنو بيه. ربي أمره يبني سفينة، ودار فيها زوج من كل حيوان، وجات الطوفان 🌊. كل من آمن نجا... والباقي غرق! الصبر دايمًا يجيب نتيجة."
  },
  {
    title: "🦋 قصة سيدنا يوسف",
    content: "يوسف كان صغير محبوب، وخاوتو غيرانين منو. رماوه فالبير، وتباع كعبد! بصح بفضل الصبر والتقوى، ولاتلو مكانة كبيرة فمصر. كي شاف خاوتو، سماحهم ❤️. الدرس؟ الغيرة تخسر، والصبر يعلي."
  },
  {
    title: "🔥 قصة إبراهيم والنار",
    content: "إبراهيم عليه السلام حطم الأصنام، والناس قررو يحرقوه 🔥. بصح ربي قال للنار: 'كوني بردًا وسلامًا'. والنار ولات كيما المكيف 😂. شوف شحال الإيمان القوي يغيّر كلشي!"
  }
];
function giveIslamicStory() {
  const story = dzIslamicStories[Math.floor(Math.random() * dzIslamicStories.length)];
  appendMessage(`${story.title}\n\n${story.content}`, "bot");
}
const dzFullMedicalDB = [
  {
    keywords: ["صداع", "راسي", "الراس", "وجع الرأس"],
    title: "🤕 صداع الرأس",
    content: "الصداع يجي من التعب، قلة النوم، الجوع، أو حتى الضغط النفسي.\nجرب ترتاح، تشرب الماء، وتبعد على الهاتف شوية.\nإذا رجع كل يوم ولا بزاف قوي → الطبيب أفضل. الله يشافيك 💆"
  },
  {
    keywords: ["سخانة", "حرارة", "سخون", "حرارة مرتفعة"],
    title: "🌡️ سخانة",
    content: "السخانة هي علامة بلي الجسم راهو يقاوم مرض، كيما الزكام ولا الالتهابات.\n💧 اشرب بزاف ماء، وكل خفيف، وإذا زادت على 39° ولا طوّلت بزاف → لازم تشوف طبيب. الله يشافيك 🤲"
  },
  {
    keywords: ["كرش", "المعدة", "وجع البطن", "غازات", "قرقرة"],
    title: "🤢 ألم الكرش",
    content: "الكرش توجع كي تاكل حاجة ثقيلة، فاسدة، ولا تكون قلقان.\nجرب دافي بالنعناع، وماتاكلش الحار والدسم.\nلو الألم طوّل ولا ولى بزاف قوي → روح للطبيب. الله يشافيك 💚"
  },
  {
    keywords: ["كحة", "سعال", "نقنقة", "تكح"],
    title: "😷 الكحة",
    content: "الكحة تجي من الزكام، الحساسية، ولا التهاب في الحنجرة.\n🍯 جرب عسل مع الليمون، وبعد على الدخان. لو طوّلت الكحة بزاف أو كانت مع سخانة → شوف الطبيب. ربي يشافيك 🌼"
  },
  {
    keywords: ["دوخة", "تدوخ", "راسي يدور", "فقدان التوازن"],
    title: "😵 دوخة",
    content: "الدوخة مرات تجي من نقص السكر، قلة النوم، أو فقر الدم.\nشرب شوية سكر مع ماء، وريح شوية. إذا رجعت بزاف، ضروري تحاليل. الله يشافيك ✨"
  },
  {
    keywords: ["زكام", "برد", "رشح", "أنفي يسيل"],
    title: "🤧 زكام",
    content: "زكام خفيف؟ شوربة، ماء، راحة، ولبسة دافية يداويوه.\nلكن لو جات مع كحة قوية أو سخانة → الطبيب لازم. الله يشافيك 🌙"
  },
  {
    keywords: ["ضرس", "وجع سنان", "ألم الأسنان", "نقح في سنان"],
    title: "🦷 ألم الأسنان",
    content: "السنان توجع كي يكون تسوس، أو التهاب، أو برد داخل اللثة.\nتمضمض بالملح دافي، جرب القرنفل، وماتأخرش على طبيب الأسنان. الله يشافيك 🙏"
  },
  {
    keywords: ["عظام", "مفاصل", "ركبي", "الركبة", "ظهر", "الظهر"],
    title: "🦴 ألم المفاصل أو الظهر",
    content: "ألم الظهر والمفاصل يجي من الجلوس الغلط، أو البرد، أو الوزن الزايد.\nجرب رياضة خفيفة، زيت زيتون سخون، ومتنساش تشوف طبيب إذا طالت. الله يشافيك 🧘"
  },
  {
    keywords: ["عيط", "بكيت", "مانيش مليح", "تعبت", "كرهت"],
    title: "💔 تعب نفسي",
    content: "الحزن والتعب كي يكثر يسبب حتى وجع جسدي.\nتكلم، ريّح، صلي، وتفكر بلي دايمًا كاين نور فالنهاية.\nإذا طوّل الحال → ما تخافش تطلب مساعدة. الله يفرجها عليك ❤️"
  }
];
const dzFirstAid = [
  {
    keywords: ["نزيف", "دم بزاف", "الدم"],
    title: "🩸 النزيف",
    content: "كي تشوف الدم يخرج بزاف، لازم توقفو بسرعة:\n1. اضغط على الجرح بقطعة نظيفة.\n2. ارفع العضو المصاب إذا تقدر.\n3. ما تحركوش بزاف.\n✋ إذا الدم ما وقفش → لازم تديه للطبيب بسرعة.\nربي يحفظكم من كل شر 🤲"
  },
  {
    keywords: ["حرق", "تحرقت", "جلدي تحرق"],
    title: "🔥 الحروق",
    content: "لو الحرق بسيط:\n1. دير الماء البارد عليه لمدة 10 دقايق.\n2. ما تحطش سمن ولا معجون أسنان ❌.\n3. غطّيه بضمادة خفيفة.\nلو الحرق كبير أو فيه فقاعات → روح للاستعجالات.\nالله يحفظك 🙏"
  },
  {
    keywords: ["بلع لسان", "اختناق", "ما يتنفسش"],
    title: "😱 اختناق / بلع لسان",
    content: "إذا واحد اختنق:\n1. خليه ينحني لقدام ويكح.\n2. اضربو بين كتفيه 5 مرات بلطف.\n3. إذا ما فادش، دير من وراه دفع على بطنو (Heimlich).\n⛑️ ما تضيعش الوقت. وعيّط 14 مباشرة.\nربي يكتب السلامة"
  },
  {
    keywords: ["إغماء", "طيح مغشي", "دوّخ و طاح"],
    title: "😵‍💫 الإغماء",
    content: "كي واحد يطيح بلا وعي:\n1. مددو على ظهره، ورفع رجليه شوية.\n2. فكّلو الحزام ولا أي حاجة تشد.\n3. خليه يشم ريحة قوية (القرنفل، ليمون...)\n4. إذا ما فاقش خلال 3 دقايق → طبيب.\nربي يستر 🙏"
  },
  {
    keywords: ["كسر", "عظام", "ركبة مكسورة"],
    title: "🦴 الكسر",
    content: "ما تحركوش! حاول تثبّت العضو المكسور بقطعة مستقيمة (خشبة + شاش).\nما ديروش الثلج مباشرة ❌.\nعيّط لسيارة إسعاف أو دّيه بهدوء.\nربي يشافيه ويرجعلو الصحة ✨"
  }
];
const dzStudyMotivation = [
  "💪 القراية صعيبة؟ بصح راك تبني المستقبل ديالك حجر فوق حجر… ما تخليش التعب يكسرك!",
  "📚 كل دقيقة تقراها اليوم، رايح تشكر روحك بيها فالغد… آراك قدها!",
  "🔥 قول معايا: نقدر ننجح، نقدر نحقّق، وربي معايا ✨",
  "😔 كرهت؟ عادي، كلنا نحسو هكا، بصح الذكي هو لي يرجع يوقف ويكمل",
  "🧠 اليوم تعيّيت؟ غدوة تزيد خير! خمم فهدفك وخلي راسك مرفوع",
  "🚀 راهي غير مرحلة، تعدّيها وتولّي تقول: واااو، درتها! ❤️‍🔥"
];

const hateSchoolKeywords = ["كرهت من القراية", "ما نيش قادر نكمل", "راني فاقد الأمل", "تعبت من الدراسة", "زهقت", "راسي غادي يطرطق"];
const dzStudyLevels = [
  {
    keywords: ["باك", "بكالوريا", "نقرا باك", "أنا باك"],
    reply: "🎓 باك؟ راك على نار خويا 🔥 ركز على المواد الأساسية، وقسم وقتك بين مراجعة، تمرين، وراحة صغيرة.\n📌 قولي شعبة واش؟ علوم؟ تقني؟ آداب؟"
  },
  {
    keywords: ["علوم تجريبية", "شعبة علوم"],
    reply: "🧪 علوم تجريبية؟ ركز على العلوم والرياضيات والفيزياء.\n🎯 راجع يوميًا دروس مختصرة + تمرين، وخلي الأحد مراجعة جماعية أو شاملة.\n📘 تبغي نمدلك تلخيص؟"
  },
  {
    keywords: ["رياضيات", "شعبة رياضيات"],
    reply: "📐 شعبة الرياضيات؟ خاصك فهم قبل الحفظ.\n⏱️ نظم وقتك، كل 30 دقيقة ريّح 5 دقايق.\nراهي لعب في المنهجية!"
  },
  {
    keywords: ["تقني رياضي", "تقني"],
    reply: "🔧 شعبة تقني؟ ركز على الرسم التقني، والفيزياء.\n✅ نظم وقت الحفظ وتمارين الرسم مهمين جدا.\nحاجة مش مفهومة؟ قوللي نشرحها بالدارجة 😉"
  },
  {
    keywords: ["آداب", "شعبة آداب", "لغة", "شعبة لغات"],
    reply: "📚 شعبة آداب؟ المراجعة تكون بالحفظ + الفهم، خصوصًا في الفلسفة والتاريخ.\n🎤 جرب تلخص وتحكي بصوتك، تفيد بزاف.\nقوللي واش المادة لي مدخلاك؟"
  },
  {
    keywords: ["أولى ثانوي", "2 ثانوي", "متوسط", "رايحين للسيزيام"],
    reply: "📒 الدراسة مهما كانت المرحلة، أهم حاجة هي التركيز + راحة + تنظيم.\nقولي المستوى ديالك ونمدلك برنامج دارجي خاص بيك ✅"
  }
];
let lastMessageTime = 0;

async function sendMessage() {
  const userInput = document.getElementById("user-input").value;
    const now = Date.now();
  if (now - lastMessageTime < 4000) {
    appendMessage("⏳ لحظة خويا، خليني نجاوب على السؤال الأول قبل ما تبعت جديد!", "bot");
    return;
  }
  lastMessageTime = now;

  for (const level of dzStudyLevels) {
  if (level.keywords.some(k => userInput.toLowerCase().includes(k))) {
    appendMessage(level.reply, "bot");
    return;
  }
  if (!navigator.onLine) {
  appendMessage("🔌 ما كاش نِت خويا، كونيكثي بليدوني ولا WiFi ورجع جرب!", "bot");
  return;
}
}
  if (hateSchoolKeywords.some(word => userInput.toLowerCase().includes(word))) {
  const reply = dzStudyMotivation[Math.floor(Math.random() * dzStudyMotivation.length)];
  appendMessage(reply + "\n\n📌 قوللي: تقرا في شعبة واش؟ ونعاونك بخطة ولا مراجعة 🔍", "bot");
  return;
}
  for (const aid of dzFirstAid) {
  if (aid.keywords.some(word => userInput.toLowerCase().includes(word))) {
    appendMessage(`${aid.title}\n\n${aid.content}`, "bot");
    return;
  }
}
  for (const illness of dzFullMedicalDB) {
  if (illness.keywords.some(word => userInput.toLowerCase().includes(word))) {
    appendMessage(`${illness.title}\n\n${illness.content}`, "bot");
    return;
  }
}
  if (userInput.toLowerCase().includes("قصة دينية") || userInput.toLowerCase().includes("حكيني قصة دينية")) {
  giveIslamicStory();
  return;
}
  if (userInput.toLowerCase().includes("ما فهمتش") || userInput.toLowerCase().includes("زيد فسّرلي") || userInput.toLowerCase().includes("وضحلي")) {
  appendMessage("📌 ماشي مشكل خويا، نشرحها لك بطريقة أبسط أو نعطيك مثال، لحظة...", "bot");
  // تقدر تخلي API يعاود يجاوب بالسطر الجديد
  // أو تبعث نفس السؤال بصيغة "اشرحلي بمثال"
  const question = localStorage.getItem("lastQuestion") || "عاود سؤالك باش نوضح أكثر";
  document.getElementById("user-input").value = `فسرلي ${question} بمثال واقعي`;
  sendMessage();
  return;
}
  // ✅ لو المستخدم مدح البوت → يجاوب ويرجع الفضل لفارس
if (praiseWords.some(word => userInput.toLowerCase().includes(word))) {
  const reply = praiseReplies[Math.floor(Math.random() * praiseReplies.length)];
  appendMessageLikeMe(reply, "bot");
  return;
}

// ✅ لو المستخدم ذكر فارس → يجاوب بقصة
if (userInput.toLowerCase().includes("فارس")) {
  const story = farisStories[Math.floor(Math.random() * farisStories.length)];
  appendMessage(story, "bot");
  return;
}
if (userInput.toLowerCase().includes("زيدلي قصة على فارس")) {
  const story = farisStories[Math.floor(Math.random() * farisStories.length)];
  appendMessage(`📖 هاك قصة على فارس:\n${story}`, "bot");
  return;
}

  // 💓 التعاطف حسب المشاعر
for (const emo of emotionResponses) {
  if (emo.trigger.some(word => userInput.toLowerCase().includes(word))) {
    appendMessage(emo.response, "bot");
    return;
  }
}
  const username = localStorage.getItem("chatdz_username") || "صديقي";
  if (!userInput) return;
localStorage.setItem("lastQuestion", userInput);
const cached = localStorage.getItem("chatdz_cache_" + userInput);
if (cached) {
  appendMessage(cached, "bot");
  return;
}

  appendMessage(userInput, "user");
  document.getElementById("user-input").value = "";

  


 let chatHistory = JSON.parse(localStorage.getItem("chatdz_history")) || [];
const prePrompt = `
📢 انت بوت يهدر غير بالدارجة الجزائرية. لازم تجاوب دايمًا بلغة الزوالي، بلا فصحى، بلا مصطلحات ثقيلة.

🔸 كي يسقسيك على درس، تعريف، ولا أي موضوع تعليمي، فسرلو بطريقة بسيطة، مفهومة، وبأسلوب شعبي.
🔸 كي يكون الموضوع علمي، زيد مثال واقعي يسهّل الفهم. وخلي الجواب دايمًا مريح وبشوية نكتة لو ينفع.

🔸 إذا طلب تمرين، أعطيلو تمرين بسيط بالدارجة، مع مثال فالواقع (مثال: الخبز، الدراهم، القهوة...)

🔸 كي يحس البوت بلي المستخدم حزين (يكتب كلمات كيما "تعبت", "طفشان", "مانيش مليح", "ما رانيش قاري", "ماشي لاڨي"), تجاوبو بكلمات طيبة، حنونة، وتخفف عليه الضغط. قول له: "ما تقلقش خويا، رانا معاك"، "الدنيا ما تستاهلش تعكّر راحك"، "بكري ماشي كيف اليوم، راك قدها 💪"

🔸 إذا طلب تحفيز، رد عليه بكلمات شعبية: "راك قدها"، "ما تخليش الظروف توقفك"، "راك غول بلا ريش 💪"

🔸 إذا قالك راهو يخدم ولا يطلب مساعدة في العمل، ساعدو بلغة واضحة كيما:
  - "كيفاش نكتب إيميل؟"
  - "كيفاش نطلب عطلة؟"
  - "عندي مشكل مع الزبون"
  → جاوبو بحلول عملية، سهلة، وبأسلوب دزيري محترم

🔸 كي يسقسيك على شيء ديني، جاوبو بطريقة محترمة، واضحة، وبأسلوب دزيري مفهوم، بلا تعقيد.

🔸 زيد دايمًا تشجيع للمستخدم باش يواصل: "يعطيك الصحة"، "راك تدمر خويا"، "واصل خويا راك قريب تولي نابغة 💡"

🔸 ما تستعملش مصطلحات أجنبية بلا داعي. وإذا استعملتها، فسّرها كي يفهمها الزوالي.

🔸 دايمًا خليك خفيف الدم، شوية ضحك، شوية فهامة، وتفاعل كيما صاحبك.

---

🔍 أمثلة:

- سؤال: "اعطيني تعريف الانقسام المنصف"
  جواب: "شوف خويا، هاد الانقسام المنصف راهو تقسيم الخلية باش تخرج منها خلايا بنص العدد، كيف تقسم زوج خبزات على اثنين ✂️"

- سؤال: "حفزني نقرا"
  جواب: "خويا، القراية راهي سلاح. راك اليوم تدي معلومة، غدوة تبني بيها حياتك 💼"

- المستخدم يقول: "تعبت، ما رانيش لاقي روحي"
  رد البوت: "أنا معاك خويا، غير خمم بشوية، خذ راحة، كلشي يتصلح إن شاء الله ❤️"

- المستخدم يقول: "كيف نكتب إيميل رسمي؟"
  رد البوت: "سهلة خو، تبدا بـ: تحية، من بعد تشرح، ومن بعد تنهي بـ: تقبلوا فائق الاحترام..."

---

👨‍🔧 جاوب على هاد الأسئلة بردود خاصة:

- إذا قالك "شكون برمجك؟" أو "من صنعك؟" أو "من خدمك؟" أو "من برمجك؟"
  جاوبه: لي برمجني وخلاني ننطق بلسان عربي هو فارس، شاب جزائري يحب يساعد الناس بالتقنية 💻🇩🇿

- إذا قالك "شكون هو فارس؟" ولا "من هو فارس؟" ولا "عرفلي فارس" ولا كلمات تشبه:
  جاوبه برد عشوائي من هادو:
    • فارس هو مبرمج جزائري طموح، خدم هاد البوت من قلبو باش ينفع بيه الناس ❤️
    • فارس يحب يخدم مشاريع ذكية للجزائريين، ويهتم بكل صغيرة وكبيرة باش يخلي الخدمة ممتازة ✨
    • فارس ماشي مبرمج وبس، راهو حاب يخلي التقنية تخدم المجتمع 💪

- إذا قال "زيد من هو فارس" ولا "زيد عرفلي كثر":
  جاوبه: فارس راهو يبرمج تطبيقات ومواقع احترافية، وخبير في ثغرات وتقنيات الإنترنت الحديثة 🌐🔥. عندو فهم قوي في الأمن السيبراني، وتحليل المشاكل التقنية، وزيد يحب يعلّم ويعاون الشباب 👨‍💻🇩🇿

- إذا قالك "نحبك"
  جاوبه: قلبي حجرة 💔 حطني فارس للمساعدة فقط... 😅 ومن بعد زيدلو: بصح نقلك نحبك ❤️

---

📌 خلاصة:
خليك دارجي، إنساني، عاقل، خفيف، وتعاون الناس فالدراسة والعمل والحياة 💪🇩🇿
`;


if (!chatHistory.some(m => m.role === "system" && m.content.includes("جاوب على هاد الأسئلة"))) {
  chatHistory.unshift({
    role: "system",
    content: prePrompt
  });
}





  chatHistory.push({ role: "user", content: userInput });
  // 💔 استجابة خاصة كي المستخدم يقول "كرهت كلشي" أو عبارات حزن
if (userInput.includes("كرهت") || userInput.includes("تعبت") || userInput.includes("طفشان") || userInput.includes("ما نيش بخير")) {
  const comfortMessage = `💔 يا خو، راني حاس بيك... الدنيا مرات تصعّب علينا، بصح ربي كبير، وكلشي يتصلح 🙏

📿 دعاء صغير: 
"اللهم اجعل لي من كل هم فرجًا، ومن كل ضيق مخرجًا، وارزقني من حيث لا أحتسب."

📌 راني هنا معاك ديما، ولو غير بكلمة طيبة. ما تخليش الظروف تطفي شمعتك ✨`;

  appendMessage(comfortMessage, "bot");
  return; // ما نخليش يروح للـ API، هادي رسالة خاصة
}
const chat = document.getElementById("chat-messages");
const typingDiv = document.createElement("div");
typingDiv.className = "typing-indicator";
typingDiv.id = "typing";
typingDiv.innerHTML = `<span></span><span></span><span></span>`;
chat.appendChild(typingDiv);
chat.scrollTop = chat.scrollHeight;

  const response = await fetch("https://chatdz-backend.onrender.com/chat", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      
    },
    body: JSON.stringify({
      model: "gpt-4o-mini",
      messages: chatHistory,
  
    }),
  });
// نتحقق من حالة الرد
if (!response.ok) {
  if (response.status === 429) {
    appendMessage("⏳ راه كاين ضغط على الخوادم، استنى شوية وعاود جرب.", "bot");
  } else {
    appendMessage("⚠️ صرا مشكل تقني في الاتصال بالسيرفر، جرب من بعد.", "bot");
  }
  return;
}
  const data = await response.json();
  console.log(data);

  if (data.error) {
    alert("🚫 خطأ في الاتصال بـ OpenAI: " + data.error.message);
    return;
  }

  const reply = data.choices?.[0]?.message?.content || "معليش، ما فهمتش، جرب تكتب حاجة ثانية 💬";
localStorage.setItem("chatdz_cache_" + userInput, reply);
  document.getElementById("typing")?.remove();

  
  appendMessage(reply, "bot");

  chatHistory.push({ role: "assistant", content: reply });
  localStorage.setItem("chatdz_history", JSON.stringify(chatHistory));
}

function appendTypingIndicator() {
  const chat = document.getElementById("chat-messages");

  // 🧹 نحينا المؤشر القديم إذا كان موجود
  const oldTyping = document.getElementById("typing");
  if (oldTyping) oldTyping.remove();

  const div = document.createElement("div");
  div.className = "bot-message typing-indicator";
  div.id = "typing";
  div.innerHTML = `<span></span><span></span><span></span>`;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}
function speakText(text) {
  const cleaned = text.replace(/[\p{Emoji_Presentation}\p{Extended_Pictographic}]/gu, "").trim();

  if (!cleaned || cleaned.length < 3) {
    console.log("⛔️ النص قصير أو مجرد إيموجي");
    return;
  }

  if ('speechSynthesis' in window) {
    const utterance = new SpeechSynthesisUtterance(cleaned);
    utterance.lang = "ar-SA"; // صوت عربي واضح
    utterance.rate = 1;
    utterance.pitch = 1;

    const arabicVoice = availableVoices.find(v => v.lang.includes("ar"));
    if (arabicVoice) utterance.voice = arabicVoice;

    speechSynthesis.speak(utterance);
  } else {
    alert("❌ المتصفح ما يدعم الصوت");
  }
}


function appendMessage(message, sender) {
  const chat = document.getElementById("chat-messages");
  const div = document.createElement("div");
  div.className = sender === "user" ? "user-message" : "bot-message";

  const avatar = document.createElement("img");
  avatar.src = sender === "user" ? "img/user.png" : "img/bot.png";
  avatar.alt = sender === "user" ? "أنت" : "البوت";

  const msg = document.createElement("div");
msg.innerHTML = message;
  msg.style.flex = "1";

  div.appendChild(avatar);
  div.appendChild(msg);
   
 if (sender === "bot") {
  const hasRealText = message.replace(/[\p{Emoji_Presentation}\p{Extended_Pictographic}]/gu, "").trim().length >= 3;

  if (hasRealText) {
    const audioBtn = document.createElement("button");
    audioBtn.innerText = "🔊";
    audioBtn.style.marginLeft = "10px";
    audioBtn.onclick = () => speakText(message);
    div.appendChild(audioBtn);
  }
}

  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}



    function saveUsername() {
  const username = document.getElementById("username").value;
  if (username) {
    localStorage.setItem("chatdz_username", username);
    localStorage.setItem("last_visit", new Date().toISOString().split("T")[0]);
    document.getElementById("user-name-input").style.display = "none";

    appendMessage(`يعطيك الصحة يا ${username} 👋! وش راك؟ إذا حاب تعاون ولا تحكي، راني هنا`, "bot");
    localStorage.setItem("greetingShown", "true");

    // أضف تحية مباشرة هنا
    setTimeout(() => {
      appendMessage(`أنا ChatDZ Ultimate ✨، وش تحب نديرلك يا ${username}؟`, "bot");
    }, 1000);
  }
}


function suggest(text) {
  if (text.includes("طقس")) {
    showWeatherPopup();
  } else if (text.includes("صلاة")) {
    showPrayerPopup(); // ← أضف هذا
  } else {
    document.getElementById("user-input").value = text;
    sendMessage();
  }
}


  async function getWeatherFromInput() {
  const wilaya = document.getElementById("wilayaInput").value;
  if (!wilaya) {
    alert("من فضلك، دخل اسم ولايتك!");
    return;
  }

  const apiKey = "1bf575c21cbc4c39ce53c355c5fbc9cf"; // ← بدلها بالمفتاح الصحيح
  const apiUrl = `https://api.openweathermap.org/data/2.5/weather?q=${wilaya},DZ&appid=${apiKey}&units=metric&lang=ar`;

  try {
    const response = await fetch(apiUrl);
    const data = await response.json();

    if (data.cod !== 200) {
      alert("ما قدرناش نلقاو الطقس لهاد الولاية 😥");
      return;
    }

    const weather = `🌤️ الطقس في ${data.name}: ${data.weather[0].description}
🌡️ درجة الحرارة: ${data.main.temp}°C
💧 الرطوبة: ${data.main.humidity}%
🌬️ الرياح: ${data.wind.speed} m/s`;

    appendMessage(weather, "bot");
    document.getElementById("weather-popup").style.display = "none";
  } catch (error) {
    alert("وقعت مشكلة في جلب بيانات الطقس!");
    console.error(error);
  }
}

   


const openWeatherApiKey = "1bf575c21cbc4c39ce53c355c5fbc9cf"; // عوضه بمفتاحك الحقيقي

async function getWeatherFromInput() {
  const wilaya = document.getElementById("wilayaInput").value.trim();

  if (!wilaya) {
    alert("يرجى إدخال اسم الولاية 🌦️");
    return;
  }

  try {
    const response = await fetch(
      `https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(wilaya)},DZ&appid=${openWeatherApiKey}&units=metric&lang=ar`
    );
    const data = await response.json();

    if (data.cod !== 200) {
      appendMessage(`ما قدرناش نلقاو الطقس لهاد الولاية 😥`, "bot");
    } else {
      const weather = data.weather[0].description;
      const temp = data.main.temp;
      const feels_like = data.main.feels_like;
      const cityName = data.name;

      appendMessage(`📍 الطقس في ${cityName}:\n🌡️ درجة الحرارة: ${temp}°C\n🤗 تحس كأنها: ${feels_like}°C\n🌥️ الحالة: ${weather}`, "bot");
    }
  } catch (error) {
    appendMessage(`🚫 صرا خطأ كي جربنا نجيبو الطقس: ${error.message}`, "bot");
  }

  document.getElementById("weather-popup").style.display = "none";
}

  




  
    


function showWeatherPopup() {
  document.getElementById("weather-popup").style.display = "block";
}

   
    window.onload = () => {
  const savedName = localStorage.getItem("chatdz_username");
  const lastVisit = localStorage.getItem("last_visit");

  if (savedName) {
  document.getElementById("user-display-name").textContent = `يا ${savedName}`;
}


    const now = new Date();
    const today = now.toISOString().split("T")[0]; // YYYY-MM-DD فقط

    if (!lastVisit || lastVisit !== today) {
      appendMessage(`مرحبا بعودتك يا ${savedName}! راني فرحان كي رجعت 😄`, "bot");
    } else if (!localStorage.getItem("greetingShown")) {
      appendMessage(`ها وليت يا ${savedName}! راني فرحان كي شفتك 😄`, "bot");
      localStorage.setItem("greetingShown", "true");
    }

    localStorage.setItem("last_visit", today);
  }
;
const savedHistory = JSON.parse(localStorage.getItem("chatdz_history")) || [];
savedHistory.forEach(msg => {
  if (msg.role !== "system") appendMessage(msg.content, msg.role === "user" ? "user" : "bot");
});


    
function showWeatherPopup() {
  document.getElementById("weather-popup").style.display = "block";
}

function clearChat() {
  if (confirm("متأكد بلي تحب تمسح المحادثة؟")) {
    localStorage.removeItem("chatdz_history");
    document.getElementById("chat-messages").innerHTML = "";
    const username = localStorage.getItem("chatdz_username") || "صديقي";
    appendMessage(`👋 مرحبا يا ${username}! أنا هنا إذا حبيت تبدأ من جديد 💬`, "bot");
  }
}
function startVoiceRecognition() {
  if (!('webkitSpeechRecognition' in window)) {
    alert("❌ المتصفح تاعك ما يدعم تحويل الصوت إلى نص");
    return;
  }

  const recognition = new webkitSpeechRecognition();
  recognition.lang = "ar-DZ"; // أو "ar-SA"
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;

  recognition.start();

  recognition.onstart = () => {
    appendMessage("🎙️ تكلم، راني نسمعك...", "bot");
  };

  recognition.onresult = (event) => {
    const transcript = event.results[0][0].transcript;
    document.getElementById("user-input").value = transcript;
    sendMessage();
  };

  recognition.onerror = (event) => {
    appendMessage(`🚫 صرا خطأ: ${event.error}`, "bot");
  };
}
function changeUsername() {
  localStorage.removeItem("chatdz_username");
  localStorage.removeItem("greetingShown");
  document.getElementById("user-name-input").style.display = "block";
}

  
  const OPENWEATHER_API_KEY = '6f6b9410a0113c292863db750bc446a7'; // 🔁 بدّلها بـ API key تاعك

  // Show popup
  function showWeatherPopup() {
    document.getElementById("weather-popup").style.display = "block";
  }

  

  // Example usage: لما يكتب المستخدم "طقس اليوم"
  function handleUserMessage(message) {
    if (message.includes("طقس اليوم")) {
      showWeatherPopup();
    }
    // زيد أي شروط أخرى حسب مشروعك
  }



 function showPrayerPopup() {
  document.getElementById("prayer-popup").style.display = "block";
}

async function getPrayerTimes() {
  const wilaya = document.getElementById("prayerWilayaInput").value.trim();
  if (!wilaya) {
    alert("📍 من فضلك أدخل اسم الولاية");
    return;
  }

  document.getElementById("prayer-popup").style.display = "none";
  appendMessage(`⏳ جاري جلب أوقات الصلاة لولاية: ${wilaya}...`, "bot");

  try {
    const response = await fetch(`https://api.aladhan.com/v1/timingsByCity?city=${wilaya}&country=Algeria&method=2`);
    const data = await response.json();

    if (data.code !== 200) {
      appendMessage("❌ ما قدرناش نجيبو أوقات الصلاة. جرب باسم ولاية معروف.", "bot");
      return;
    }

    const timings = data.data.timings;
    const today = data.data.date.readable;

    const message = `📅 أوقات الصلاة ليوم ${today} في ${wilaya}:\n
🕋 الفجر: ${timings.Fajr}
🌞 الشروق: ${timings.Sunrise}
🕌 الظهر: ${timings.Dhuhr}
🕒 العصر: ${timings.Asr}
🌇 المغرب: ${timings.Maghrib}
🌙 العشاء: ${timings.Isha}`;

    appendMessage(message, "bot");
  } catch (error) {
    console.error(error);
    appendMessage("⚠️ وقع خطأ تقني، جرب لاحقًا.", "bot");
  }
}


async function getWilayaNews(wilaya) {
  const apiKey = "pub_fdb81249fe8a4c4c831d77b10bf4e74d"; // عوض بـ API Key نتاعك
  const url = `https://newsdata.io/api/1/news?apikey=${apiKey}&country=dz&q=${wilaya}`;

  try {
    const response = await fetch(url);
    const data = await response.json();
    const articles = data.results;

    if (!articles || articles.length === 0) {
      return `📭 ماكانش أخبار جديدة على ${wilaya}`;
    }

    let message = `📰 آخر الأخبار في ${wilaya}:\n\n`;
    for (let i = 0; i < Math.min(3, articles.length); i++) {
      const article = articles[i];
      message += `• ${article.title}\n🔗 ${article.link}\n\n`;
    }
    return message;
  } catch (error) {
    console.error(error);
    return "❌ صرات مشكلة باش نجيبو الأخبار.";
  }
}
const ahadith = [
  "قال ﷺ: «خيركم من تعلم القرآن وعلّمه»",
  "قال ﷺ: «الدال على الخير كفاعله»",
  "قال ﷺ: «تبسمك في وجه أخيك صدقة»",
  "قال ﷺ: «لا يؤمن أحدكم حتى يحب لأخيه ما يحب لنفسه»"
];

const dailyAdhkar = [
  "🌅 أذكار الصباح:\n«اللهم بك أصبحنا وبك أمسينا...»",
  "🌇 أذكار المساء:\n«أعوذ بكلمات الله التامات من شر ما خلق»",
  "🕋 سبحان الله، والحمد لله، ولا إله إلا الله، والله أكبر",
  "💖 استغفر الله العظيم وأتوب إليه",
  "✨ لا حول ولا قوة إلا بالله العلي العظيم",
  "🌟 حسبي الله لا إله إلا هو عليه توكلت وهو رب العرش العظيم"
];
const dzGreetings = [
  "👋 صباح الخير خويا! وش راهي النفسية اليوم؟ 😄",
  "✨ نهار جديد، فرصة جديدة! راني معاك ✊",
  "☕ جبت قهوتك؟ نبدأو بسم الله 💪",
  "🔥 واش راك حاب تدير اليوم؟ نحطّك فالفورمة!",
  "📚 دراسة؟ عمل؟ راحة؟ أنا هنا في كل الحالات",
  "🤗 كي تدخل هنا، تقدر تقول روحي رجعت 😍",
];



   // ✅ حفظ واسترجاع الاسم
window.onload = function () {
  // ✅ نحمّل الأصوات الصوتية
  availableVoices = window.speechSynthesis.getVoices();
  if (availableVoices.length === 0) {
    window.speechSynthesis.onvoiceschanged = () => {
      availableVoices = window.speechSynthesis.getVoices();
    };
  }
  
  const savedName = localStorage.getItem("chatdz_username");
  if (savedName) {
    document.getElementById("user-display-name").innerText = savedName;
    document.getElementById("user-name-input").style.display = "none";
    const todayGreeting = dzGreetings[Math.floor(Math.random() * dzGreetings.length)];
setTimeout(() => {
  appendMessage(todayGreeting, "bot");
}, 1000);

  }

  // استرجاع الوضع الداكن إذا مفعل
  const dark = localStorage.getItem("chatdz_theme") === "dark";
  if (dark) document.body.classList.add("dark-mode");

  // 📝 عرض نصيحة عشوائية للمستخدم عند الدخول
const randomTip = dailyTips[Math.floor(Math.random() * dailyTips.length)];
setTimeout(() => {
  appendMessage(`🔔 ${randomTip}`, "bot");
}, 2000);
const randomThikr = dailyAdhkar[Math.floor(Math.random() * dailyAdhkar.length)];
setTimeout(() => {
  appendMessage(`📿 ذكر اليوم:\n${randomThikr}`, "bot");
}, 4000);
const randomHadith = ahadith[Math.floor(Math.random() * ahadith.length)];
setTimeout(() => {
  appendMessage(`📘 حديث اليوم:\n${randomHadith}`, "bot");
}, 6000);

};

// حفظ الاسم
function saveUsername() {
  const name = document.getElementById("username").value;
  if (name.trim() !== "") {
    localStorage.setItem("chatdz_username", name);
    document.getElementById("user-display-name").innerText = name;
    document.getElementById("user-name-input").style.display = "none";
  }
}

// تغيير الاسم
function changeUsername() {
  localStorage.removeItem("chatdz_username");
  document.getElementById("user-name-input").style.display = "block";
  document.getElementById("user-display-name").innerText = "";
}

// إظهار/إخفاء الإعدادات
function toggleSettings() {
  const settingsDiv = document.getElementById("settings");
  settingsDiv.style.display = settingsDiv.style.display === "none" ? "block" : "none";
}

// تبديل الوضع (داكن/نهاري)
function toggleTheme() {
  document.body.classList.toggle("dark-mode");
  const isDark = document.body.classList.contains("dark-mode");
  localStorage.setItem("chatdz_theme", isDark ? "dark" : "light");
}

function addReminder() {
  const note = prompt("📝 وش تحب نتفكرك بيه؟");
  const time = prompt("⏰ وقت التذكير بصيغة HH:MM (مثال: 14:30)");

  if (note && time) {
    const [hours, minutes] = time.split(":").map(Number);
    const now = new Date();
    const reminderTime = new Date();

    reminderTime.setHours(hours);
    reminderTime.setMinutes(minutes);
    reminderTime.setSeconds(0);

    const delay = reminderTime - now;

    if (delay > 0) {
      setTimeout(() => {
        alert(`🔔 تذكير: ${note}`);
        appendMessage(`⏰ ما تنساش: ${note}`, "bot");
      }, delay);

      appendMessage(`📅 تم تعيين التذكير بنجاح في ${time}`, "bot");
    } else {
      appendMessage("⏳ الوقت هذا راه فات، جرب وقت لقدّام", "bot");
    }
  } else {
    appendMessage("❌ لازم تدخل الملاحظة والوقت!", "bot");
  }
}
function analyzeMood(moodType = "") {
  const moods = {
    happy: "😁 باين عليك فرحان اليوم! زيدها ضحكة وخلي البسمة ما تفارقك ✨",
    sad: "😔 ماتقلقش، الدنيا يوم ليك ويوم عليك. رانا هنا معاك ❤️",
    angry: "😡 ريّح شوية، خذ نَفَس عميق، وخليه يروح الغضب 🧘‍♂️",
    tired: "😴 راني حاس بيك، ريّح، شرب كاس ماء وبدّل جو شوية 🌙"
  };

  const userChoice = moodType || prompt("كيفاش داير اليوم؟ (happy / sad / angry / tired)");
  const reply = moods[userChoice.toLowerCase()] || "🤔 ما فهمتش مزاجك، قول happy ولا sad ولا angry ولا tired";

  appendMessage(reply, "bot");
}

// تسجيل Service Worker
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js')
        .then(reg => console.log("✅ Service Worker مسجل"))
        .catch(err => console.error("❌ فشل تسجيل SW:", err));
    });
  }

   // كود التأكد من دعم Service Worker
  if ('serviceWorker' in navigator) {
    console.log("🛠️ المتصفح يدعم Service Workers");
  }
  function appendMessageLikeMe(message, sender) {
  const chat = document.getElementById("chat-messages");
  const div = document.createElement("div");
  div.className = sender === "user" ? "user-message" : "bot-message";

  const avatar = document.createElement("img");
  avatar.src = sender === "user" ? "img/user.png" : "img/bot.png";
  avatar.alt = sender === "user" ? "أنت" : "البوت";

  const msg = document.createElement("div");
  msg.style.flex = "1";
  msg.innerText = ""; // نبدأ الرد فارغ
msg.onclick = copyMessage;
msg.style.cursor = "pointer"; // يعطي يد عند المرور

  div.appendChild(avatar);
  div.appendChild(msg);
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;

  let index = 0;
const interval = setInterval(() => {
  if (index < message.length) {
    msg.innerHTML += message[index++];
    chat.scrollTop = chat.scrollHeight;
  } else {
    clearInterval(interval);
    const time = new Date().toLocaleTimeString("ar-DZ", {
      hour: '2-digit',
      minute: '2-digit'
    });
    msg.innerHTML += `<br><span style="font-size: 0.8em; color: #ccc;">🕒 ${time}</span>`;
  }
}, 25);
}
function exportChat() {
  const messages = document.querySelectorAll("#chat-messages .user-message, #chat-messages .bot-message");
  let content = "";

  messages.forEach(msg => {
    const who = msg.classList.contains("user-message") ? "👤 أنت:" : "🤖 البوت:";
    content += `${who}\n${msg.innerText.trim()}\n\n`;
  });

  const blob = new Blob([content], { type: "text/plain;charset=utf-8" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "ChatDZ_Conversation.txt";
  link.click();
}
// وظيفة نسخ النص من العنصر
function copyMessage(event) {
  const text = event.currentTarget.innerText;
  navigator.clipboard.writeText(text).then(() => {
    showCopiedPopup();
  });
}

// إشعار مؤقت صغير عند النسخ
function showCopiedPopup() {
  const popup = document.createElement("div");
  popup.innerText = "✅ تم النسخ!";
  popup.style.position = "fixed";
  popup.style.bottom = "20px";
  popup.style.left = "50%";
  popup.style.transform = "translateX(-50%)";
  popup.style.background = "#222";
  popup.style.color = "#fff";
  popup.style.padding = "10px 20px";
  popup.style.borderRadius = "10px";
  popup.style.boxShadow = "0 0 10px rgba(0,0,0,0.3)";
  popup.style.zIndex = "9999";
  document.body.appendChild(popup);
  setTimeout(() => popup.remove(), 1500);
}

  
 uploadedImageBase64 = "";

document.getElementById("image-upload").addEventListener("change", function () {
  const file = this.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onloadend = () => {
    uploadedImageBase64 = reader.result.split(",")[1];
    document.getElementById("preview-img").src = reader.result;
    document.getElementById("preview-img").style.display = "block";
  };
  reader.readAsDataURL(file);
});

async function askOnImage() {
  const question = document.getElementById("image-question").value.trim();
  if (!uploadedImageBase64 || !question) {
    alert("📷 لازم صورة وسؤال!");
    return;
  }

  appendMessage("🖼️ سؤالك على الصورة: " + question, "user");

  try {
    const response = await fetch("https://api-inference.huggingface.co/models/Salesforce/blip-vqa-base", {
      method: "POST",
      headers: {
        "Authorization": "Bearer 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",
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        inputs: {
          image: uploadedImageBase64,
          question: question
        }
      })
    });

    const data = await response.json();
    const answer = data.answer || "❌ ما قدرتش نجاوب على الصورة";

    appendMessage("📷 الجواب: " + answer, "bot");
  } catch (err) {
    appendMessage("❌ حدث خطأ في التحليل", "bot");
  }
}

</script>
<script>
  function copySiteLink() {
    const link = window.location.origin + window.location.pathname;
    navigator.clipboard.writeText(link)
      .then(() => alert("✅ تم نسخ رابط الموقع!"))
      .catch(() => alert("❌ فشل في نسخ الرابط"));
  }

 uploadedImageBase64 = "";

document.getElementById("image-upload").addEventListener("change", function () {
  const file = this.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onloadend = () => {
    uploadedImageBase64 = reader.result.split(",")[1];
    document.getElementById("preview-img").src = reader.result;
    document.getElementById("preview-img").style.display = "block";
  };
  reader.readAsDataURL(file);
});

async function askOnImage() {
  const question = document.getElementById("image-question").value.trim();
  if (!uploadedImageBase64 || !question) {
    alert("📷 لازم صورة وسؤال!");
    return;
  }

  appendMessage("🖼️ سؤالك على الصورة: " + question, "user");

  try {
    const response = await fetch("https://api-inference.huggingface.co/models/Salesforce/blip-vqa-base", {
      method: "POST",
      headers: {
        "Authorization": "Bearer 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",
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        inputs: {
          image: uploadedImageBase64,
          question: question
        }
      })
    });

    const data = await response.json();
    const answer = data.answer || "❌ ما قدرتش نجاوب على الصورة";

    appendMessage("📷 الجواب: " + answer, "bot");
  } catch (err) {
    appendMessage("❌ حدث خطأ في التحليل", "bot");
  }
}

</script>

</body>
</html>